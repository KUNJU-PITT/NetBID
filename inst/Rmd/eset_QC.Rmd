---
title: "QC plot for eSet"
output: 
  html_document
---

```{r include=FALSE}
library(NetBID2)
library(kableExtra)
```

```{r echo=FALSE}
dt <- pData(eset)
kable(dt,align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "100%")
intgroup <- get_int_group(eset)
use_mat  <- exprs(eset)
```


This eSet contains `r nrow(use_mat)` probes/transcripts/genes in `r ncol(use_mat)` samples, 
in which `r length(intgroup)` sample class: `r intgroup` will used for basic clustering analysis.

## Part I: Heatmap between samples

Distance between samples is calculated by dist2().

```{r echo=FALSE,fig.width=10, fig.height=10}
nrow <- ceiling(length(intgroup)/2)
par(mfrow = c(nrow, 2))
par(mar = c(6, 6, 6, 6))
    m <- dist2(use_mat)
    #dend <- as.dendrogram(hclust(as.dist(m), method = "single"))
    #ord <- order.dendrogram(dend)
    #m <- m[ord, ord]
    res <- draw.heatmap(mat=m,phenotype_info = pData(eset),use_phe=intgroup)
```

## Part II: PCA plot for samples

Original expression matrix is transformed by PCA (principal component analysis) and the first two components are visualized.  

```{r echo=FALSE, fig.width=12, fig.height=10}
nrow <- ceiling(length(intgroup)/2)
par(mfrow = c(nrow, 2))
   pca <- prcomp(t(na.omit(use_mat)))
   for (i in 1:length(intgroup)) {
      class_label <- pData(eset)[,intgroup[i]]
      class_label[which(is.na(class_label)==TRUE)] <- 'NA'
      par(mar = c(3, 2, 3, 4))
      draw.2D(as.data.frame(pca$x)$PC1,as.data.frame(pca$x)$PC2,class_label=class_label,
              xlab=sprintf('PC1(%s%s variance)',format(summary(pca)$importance[2,'PC1']*100,digits=3),'%'),
              ylab=sprintf('PC2(%s%s variance)',format(summary(pca)$importance[2,'PC2']*100,digits=3),'%'),
              legend_cex=0.8,main=sprintf('%s',intgroup[i]))
      par(mar = c(3, 2, 3, 2))
      draw.2D.ellipse(as.data.frame(pca$x)$PC1,as.data.frame(pca$x)$PC2,class_label=class_label,
                      xlab=sprintf('PC1(%s%s variance)',format(summary(pca)$importance[2,'PC1']*100,digits=3),'%'),
                      ylab=sprintf('PC2(%s%s variance)',format(summary(pca)$importance[2,'PC2']*100,digits=3),'%'),
                      legend_cex=0.8,main=sprintf('%s',intgroup[i]))
    }
```

## Part III: Density plot

The density for the expression value in each sample is ploted with colored grouped by the sample class. 

```{r echo=FALSE ,fig.width=12, fig.height=10}
nrow <- ceiling(length(intgroup)/2)
par(mfrow = c(nrow, 2))
par(mar = c(3, 3, 3, 3))
for(i in 1:length(intgroup)){
      all_dens <- list()
      for (j in 1:ncol(use_mat)) {
        all_dens[[j]] <- density(use_mat[,j],na.rm=TRUE)
      }
      plot(1,col = 'white',xlim=c(min(unlist(lapply(all_dens,function(x)min(x$x)))),max(unlist(lapply(all_dens,function(x)max(x$x))))),
           type = 'l',xlab = "",ylab='Density',main = sprintf('Density plot for %s',intgroup[i]),
           ylim=c(min(unlist(lapply(all_dens,function(x)min(x$y)))),max(unlist(lapply(all_dens,function(x)max(x$y))))))
      class_label <- pData(eset)[,intgroup[i]]
      cls_cc <- get.class.color(class_label)
      for (j in 1:ncol(use_mat)) {
        lines(all_dens[[j]], col = cls_cc[j])
      }
      legend('topright',legend=unique(class_label),
             fill = cls_cc[unique(class_label)],
             xpd = TRUE,border = NA,bty = 'n',horiz = FALSE)
    }
```

## Part IV: MeanSd plot

The standard deviations versus means for each probe/transcript/gene is plotted. 

```{r echo=FALSE}
    meanSdPlot(eset)
```




